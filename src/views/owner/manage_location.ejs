
<% const featureOptions = (locationMeta && locationMeta.FEATURE_LIBRARY) || [
    { value: 'View đẹp', hint: 'Rooftop, hướng biển, sông' },
    { value: 'Không gian yên tĩnh', hint: 'Đọc sách, học bài' },
    { value: 'Phù hợp làm việc', hint: 'Có ổ điện, wifi mạnh' },
    { value: 'Không gian ngoài trời', hint: 'Sân vườn, ban công' },
    { value: 'Phục vụ bánh ngọt / pastry', hint: 'Croissant, dessert' },
    { value: 'Đồ uống signature', hint: 'Cold brew, signature drink' },
    { value: 'Phù hợp gia đình / nhóm', hint: 'Không gian rộng rãi' },
    { value: 'Sống ảo / check-in', hint: 'Nhiều góc chụp đẹp' }
]; %>
<% const priceLevelOptions = (locationMeta && locationMeta.PRICE_LEVELS) || [
    { value: 'budget', label: 'Tiết kiệm (< 80k/người)' },
    { value: 'standard', label: 'Phổ biến (80k - 150k/người)' },
    { value: 'premium', label: 'Cao cấp (> 150k/người)' }
]; %>
<% const descriptionMin = (locationMeta && locationMeta.DESCRIPTION_MIN_LENGTH) || 80; %>
<% const featureMin = (locationMeta && locationMeta.FEATURE_MIN_COUNT) || 2; %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">
        <i class="fas fa-map-marker-alt text-primary me-2"></i>
        Quản lý Địa điểm
    </h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLocationModal">
        <i class="fas fa-plus me-1"></i>Tạo địa điểm mới
    </button>
</div>

<!-- Locations Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Danh sách Địa điểm
        </h5>
    </div>
    <div class="card-body">
        <% if (locations && locations.length > 0) { %>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên địa điểm</th>
                            <th>Loại</th>
                            <th>Đánh giá</th>
                            <th>Địa chỉ</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% locations.forEach(location => { %>
                            <tr>
                                <td>
                                    <img src="<%= location.imageUrl %>" class="rounded" style="width: 60px; height: 40px; object-fit: cover;">
                                </td>
                                <td>
                                    <h6 class="mb-0"><%= location.name %></h6>
                                    <small class="text-muted"><%= location.description.substring(0, 50) %>...</small>
                                </td>
                                <td><span class="badge bg-secondary"><%= location.type %></span></td>
                                <td>
                                    <div class="rating">
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <i class="fas fa-star <%= i <= location.rating ? 'text-warning' : 'text-muted' %>"></i>
                                        <% } %>
                                        <span class="ms-1">(<%= location.rating %>)</span>
                                    </div>
                                </td>
                                <td><small class="text-muted"><%= location.address.substring(0, 30) %>...</small></td>
                                <td><small class="text-muted"><%= new Date(location.createdAt).toLocaleDateString('vi-VN') %></small></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/locations/<%= location._id %>" class="btn btn-outline-primary" title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editLocationModal<%= location._id %>" title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form action="/owner/locations/<%= location._id %>" method="POST" class="d-inline" data-confirm="Bạn có chắc muốn xóa địa điểm này? Tất cả voucher và review liên quan cũng sẽ bị xóa!">
                                            <input type="hidden" name="_method" value="DELETE">
                                            <button type="submit" class="btn btn-outline-danger" title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="text-center py-5">
                <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">Chưa có địa điểm nào</h4>
                <p class="text-muted">Hãy tạo địa điểm đầu tiên của bạn!</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLocationModal">
                    <i class="fas fa-plus me-1"></i>Tạo địa điểm
                </button>
            </div>
        <% } %>
    </div>
</div>

<!-- Create Location Modal -->
<div class="modal fade" id="createLocationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Tạo địa điểm mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/owner/locations" method="POST" enctype="multipart/form-data" data-confirm="Xác nhận tạo địa điểm mới?">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Tên địa điểm *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="type" class="form-label">Loại địa điểm *</label>
                                <select class="form-select" id="type" name="type" required>
                                    <option value="">Chọn loại địa điểm</option>
                                    <option value="restaurant">Nhà hàng</option>
                                    <option value="cafe">Cafe</option>
                                    <option value="tourist_spot">Điểm du lịch</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="city" class="form-label">Thành phố / Tỉnh *</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="VD: Đà Nẵng" required>
                                <small class="text-muted">Giúp khách hàng lọc được khu vực nhanh chóng.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priceLevel" class="form-label">Mức giá trung bình *</label>
                                <select class="form-select" id="priceLevel" name="priceLevel" required>
                                    <option value="">Chọn mức giá</option>
                                    <% priceLevelOptions.forEach(option => { %>
                                        <option value="<%= option.value %>"><%= option.label %></option>
                                    <% }) %>
                                </select>
                                <small class="text-muted">Ước tính theo giá trung bình mỗi khách.</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priceMin" class="form-label">Giá tối thiểu (VND)</label>
                                <input type="number" class="form-control" id="priceMin" name="priceMin" min="0" placeholder="Ví dụ: 55000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priceMax" class="form-label">Giá tối đa (VND)</label>
                                <input type="number" class="form-control" id="priceMax" name="priceMax" min="0" placeholder="Ví dụ: 110000">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Địa chỉ *</label>
                        <input type="text" class="form-control" id="address" name="address" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Mô tả chi tiết *</label>
                        <textarea class="form-control" id="description" name="description" rows="4" minlength="<%= descriptionMin %>" required></textarea>
                        <small class="text-muted">Tối thiểu <%= descriptionMin %> ký tự, mô tả rõ view, không gian và thực đơn nổi bật.</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="city_<%= location._id %>" class="form-label">Thành phố / Tỉnh *</label>
                                <input type="text" class="form-control" id="city_<%= location._id %>" name="city" value="<%= cityValue %>" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priceLevel_<%= location._id %>" class="form-label">Mức giá trung bình *</label>
                                <select class="form-select" id="priceLevel_<%= location._id %>" name="priceLevel" required>
                                    <option value="">Chọn mức giá</option>
                                    <% priceLevelOptions.forEach(option => { %>
                                        <option value="<%= option.value %>" <%= location.priceLevel === option.value ? 'selected' : '' %>><%= option.label %></option>
                                    <% }) %>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priceMin_<%= location._id %>" class="form-label">Giá tối thiểu (VND)</label>
                                <input type="number" class="form-control" id="priceMin_<%= location._id %>" name="priceMin" min="0" value="<%= priceInfo.min || '' %>">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priceMax_<%= location._id %>" class="form-label">Giá tối đa (VND)</label>
                                <input type="number" class="form-control" id="priceMax_<%= location._id %>" name="priceMax" min="0" value="<%= priceInfo.max || '' %>">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đặc điểm nổi bật *</label>
                        <small class="text-muted d-block">Chọn tối thiểu <%= featureMin %> đặc điểm hoặc bổ sung trong phần mô tả.</small>
                        <div class="row row-cols-1 row-cols-sm-2 g-2 mt-2">
                            <% featureOptions.forEach((feature, index) => { const inputId = `feature_create_${index}`; %>
                                <div class="col">
                                    <div class="form-check border rounded p-2 h-100">
                                        <input class="form-check-input" type="checkbox" name="features[]" value="<%= feature.value %>" id="<%= inputId %>">
                                        <label class="form-check-label fw-semibold" for="<%= inputId %>"><%= feature.value %></label>
                                        <% if (feature.hint) { %>
                                            <small class="text-muted d-block"><%= feature.hint %></small>
                                        <% } %>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="menuHighlights" class="form-label">Điểm nhấn thực đơn</label>
                        <textarea class="form-control" id="menuHighlights" name="menuHighlights" rows="2" placeholder="Ngăn cách bằng dấu phẩy, ví dụ: Croissant bơ, Cold brew cam sả"></textarea>
                    </div>
                    <div class="mb-3" data-image-picker data-picker-id="create" data-initial-urls="[]" data-primary-input="#primaryImageUrl_create">
                        <label class="form-label">Hình ảnh địa điểm</label>
                        <div class="nav nav-pills mb-3" role="tablist">
                            <button class="nav-link active" id="imageTab-create-url" data-bs-toggle="pill" data-bs-target="#imagePane-create-url" type="button" role="tab">Thêm URL</button>
                            <button class="nav-link" id="imageTab-create-upload" data-bs-toggle="pill" data-bs-target="#imagePane-create-upload" type="button" role="tab">Tải từ máy</button>
                            <button class="nav-link" id="imageTab-create-drop" data-bs-toggle="pill" data-bs-target="#imagePane-create-drop" type="button" role="tab">Kéo & Thả</button>
                        </div>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="imagePane-create-url" role="tabpanel" aria-labelledby="imageTab-create-url">
                                <div class="d-flex gap-2">
                                    <input type="url" class="form-control" placeholder="https://example.com/image.jpg" data-url-input>
                                    <button type="button" class="btn btn-outline-primary" data-add-url><i class="fas fa-plus me-1"></i>Thêm</button>
                                </div>
                                <div class="mt-2" data-url-list></div>
                            </div>
                            <div class="tab-pane fade" id="imagePane-create-upload" role="tabpanel" aria-labelledby="imageTab-create-upload">
                                <input type="file" class="form-control" name="imageFiles" accept="image/*" multiple data-file-input>
                                <small class="text-muted">Chọn nhiều ảnh để tải lên máy chủ. Hệ thống sẽ tự tạo thư mục theo chủ sở hữu.</small>
                            </div>
                            <div class="tab-pane fade" id="imagePane-create-drop" role="tabpanel" aria-labelledby="imageTab-create-drop">
                                <div class="rounded p-4 text-center bg-light" style="cursor:pointer;border:2px dashed rgba(13,110,253,0.35);" data-dropzone>
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-primary"></i>
                                    <p class="mb-1">Kéo và thả ảnh vào đây</p>
                                    <p class="text-muted small mb-0">Có thể kéo nhiều ảnh cùng lúc hoặc nhấp để chọn tệp</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 small text-muted" data-file-list></div>
                        <div class="mt-2 small text-muted" data-picker-summary>Chưa chọn ảnh nào</div>
                        <input type="hidden" name="imageUrl" id="primaryImageUrl_create" value="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Tạo địa điểm
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Location Modals -->
<% if (locations && locations.length > 0) { %>
    <% locations.forEach(location => {
        const selectedFeatures = location.features || [];
        const menuHighlightText = (location.menuHighlights || []).join(', ');
        const priceInfo = location.priceRange || {};
        const cityValue = location.city || '';
    %>
        <div class="modal fade" id="editLocationModal<%= location._id %>" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-edit me-2"></i>Chỉnh sửa địa điểm
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="/owner/locations/<%= location._id %>" method="POST" enctype="multipart/form-data" data-confirm="Xác nhận cập nhật địa điểm?">
                        <input type="hidden" name="_method" value="PUT">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="name_<%= location._id %>" class="form-label">Tên địa điểm *</label>
                                        <input type="text" class="form-control" id="name_<%= location._id %>" name="name" value="<%= location.name %>" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="type_<%= location._id %>" class="form-label">Loại địa điểm *</label>
                                        <select class="form-select" id="type_<%= location._id %>" name="type" required>
                                            <option value="restaurant" <%= location.type === 'restaurant' ? 'selected' : '' %>>Nhà hàng</option>
                                            <option value="cafe" <%= location.type === 'cafe' ? 'selected' : '' %>>Cafe</option>
                                            <option value="tourist_spot" <%= location.type === 'tourist_spot' ? 'selected' : '' %>>Điểm du lịch</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="address_<%= location._id %>" class="form-label">Địa chỉ *</label>
                                <input type="text" class="form-control" id="address_<%= location._id %>" name="address" value="<%= location.address %>" required>
                            </div>
                            <div class="mb-3">
                                <label for="description_<%= location._id %>" class="form-label">Mô tả chi tiết *</label>
                                <textarea class="form-control" id="description_<%= location._id %>" name="description" rows="4" minlength="<%= descriptionMin %>" required><%= location.description %></textarea>
                                <small class="text-muted">Tối thiểu <%= descriptionMin %> ký tự để trợ lý có đủ dữ liệu gợi ý.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Đặc điểm nổi bật *</label>
                                <small class="text-muted d-block">Chọn tối thiểu <%= featureMin %> đặc điểm mô tả đúng không gian.</small>
                                <div class="row row-cols-1 row-cols-sm-2 g-2 mt-2">
                                    <% featureOptions.forEach((feature, featureIndex) => {
                                        const inputId = `feature_edit_${location._id}_${featureIndex}`;
                                        const isChecked = selectedFeatures.includes(feature.value);
                                    %>
                                        <div class="col">
                                            <div class="form-check border rounded p-2 h-100">
                                                <input class="form-check-input" type="checkbox" name="features[]" value="<%= feature.value %>" id="<%= inputId %>" <%= isChecked ? 'checked' : '' %>>
                                                <label class="form-check-label fw-semibold" for="<%= inputId %>"><%= feature.value %></label>
                                                <% if (feature.hint) { %>
                                                    <small class="text-muted d-block"><%= feature.hint %></small>
                                                <% } %>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="menuHighlights_<%= location._id %>" class="form-label">Điểm nhấn thực đơn</label>
                                <textarea class="form-control" id="menuHighlights_<%= location._id %>" name="menuHighlights" rows="2" placeholder="Ngăn cách bằng dấu phẩy"><%= menuHighlightText %></textarea>
                            </div>
                            <% const existingImages = (location.images && location.images.length ? location.images : (location.imageUrl ? [location.imageUrl] : [])); %>
                            <div class="mb-3" data-image-picker data-picker-id="edit-<%= location._id %>" data-initial-urls='<%- JSON.stringify(existingImages) %>' data-primary-input="#primaryImageUrl_<%= location._id %>">
                                <label class="form-label">Hình ảnh địa điểm</label>
                                <div class="nav nav-pills mb-3" role="tablist">
                                    <button class="nav-link active" id="imageTab-edit-<%= location._id %>-url" data-bs-toggle="pill" data-bs-target="#imagePane-edit-<%= location._id %>-url" type="button" role="tab">Thêm URL</button>
                                    <button class="nav-link" id="imageTab-edit-<%= location._id %>-upload" data-bs-toggle="pill" data-bs-target="#imagePane-edit-<%= location._id %>-upload" type="button" role="tab">Tải từ máy</button>
                                    <button class="nav-link" id="imageTab-edit-<%= location._id %>-drop" data-bs-toggle="pill" data-bs-target="#imagePane-edit-<%= location._id %>-drop" type="button" role="tab">Kéo & Thả</button>
                                </div>
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="imagePane-edit-<%= location._id %>-url" role="tabpanel" aria-labelledby="imageTab-edit-<%= location._id %>-url">
                                        <div class="d-flex gap-2">
                                            <input type="url" class="form-control" placeholder="https://example.com/image.jpg" data-url-input>
                                            <button type="button" class="btn btn-outline-primary" data-add-url><i class="fas fa-plus me-1"></i>Thêm</button>
                                        </div>
                                        <div class="mt-2" data-url-list></div>
                                    </div>
                                    <div class="tab-pane fade" id="imagePane-edit-<%= location._id %>-upload" role="tabpanel" aria-labelledby="imageTab-edit-<%= location._id %>-upload">
                                        <input type="file" class="form-control" name="imageFiles" accept="image/*" multiple data-file-input>
                                        <small class="text-muted">Chọn nhiều ảnh để tải lên máy chủ. Hệ thống sẽ tự tạo thư mục theo chủ sở hữu.</small>
                                    </div>
                                    <div class="tab-pane fade" id="imagePane-edit-<%= location._id %>-drop" role="tabpanel" aria-labelledby="imageTab-edit-<%= location._id %>-drop">
                                        <div class="rounded p-4 text-center bg-light" style="cursor:pointer;border:2px dashed rgba(13,110,253,0.35);" data-dropzone>
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-primary"></i>
                                            <p class="mb-1">Kéo và thả ảnh vào đây</p>
                                            <p class="text-muted small mb-0">Có thể kéo nhiều ảnh cùng lúc hoặc nhấp để chọn tệp</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 small text-muted" data-file-list></div>
                                <div class="mt-2 small text-muted" data-picker-summary>Chưa chọn ảnh nào</div>
                                <input type="hidden" name="imageUrl" id="primaryImageUrl_<%= location._id %>" value="<%= existingImages[0] || '' %>">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Cập nhật
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <% }) %>
<% } %>

<script>
(function() {
    function initImagePicker(container) {
        const primarySelector = container.dataset.primaryInput || '';
        const form = container.closest('form');
        const primaryInput = primarySelector && form ? form.querySelector(primarySelector) : null;
        const defaultPrimary = primaryInput ? primaryInput.value : '';
        const urlListEl = container.querySelector('[data-url-list]');
        const urlInput = container.querySelector('[data-url-input]');
        const addUrlBtn = container.querySelector('[data-add-url]');
        const fileInput = container.querySelector('[data-file-input]');
        const dropzone = container.querySelector('[data-dropzone]');
        const fileListEl = container.querySelector('[data-file-list]');
        const summaryEl = container.querySelector('[data-picker-summary]');
        const filesBuffer = new DataTransfer();
        const urlValues = [];

        function parseInitialUrls() {
            try {
                const raw = container.getAttribute('data-initial-urls') || '[]';
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) parsed.forEach(url => addUrl(url));
            } catch (err) {
                console.warn('Không thể đọc danh sách ảnh khởi tạo', err);
            }
        }

        function handleAddUrl() {
            if (!urlInput) return;
            const value = (urlInput.value || '').trim();
            if (!value) return;
            addUrl(value);
            urlInput.value = '';
        }

        function addUrl(url) {
            if (!url || urlValues.includes(url)) return;
            urlValues.push(url);
            if (urlListEl) {
                const row = document.createElement('div');
                row.className = 'd-flex align-items-center gap-2 mb-2 flex-wrap';
                row.dataset.urlEntry = url;

                const badge = document.createElement('span');
                badge.className = 'badge bg-light text-dark text-truncate';
                badge.style.maxWidth = '260px';
                badge.textContent = url;

                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'imageUrls[]';
                hidden.value = url;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.setAttribute('data-remove-url', url);
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';

                row.appendChild(badge);
                row.appendChild(hidden);
                row.appendChild(removeBtn);
                urlListEl.appendChild(row);
            }
            updatePrimaryImage();
            updateSummary();
        }

        function removeUrl(url, rowEl) {
            const idx = urlValues.indexOf(url);
            if (idx !== -1) urlValues.splice(idx, 1);
            if (rowEl) rowEl.remove();
            updatePrimaryImage();
            updateSummary();
        }

        function addFiles(fileList) {
            if (!fileList || !fileList.length) return;
            Array.from(fileList).forEach(file => {
                const exists = Array.from(filesBuffer.files).some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified);
                if (!exists) filesBuffer.items.add(file);
            });
            if (fileInput) fileInput.files = filesBuffer.files;
            renderFileList();
            updateSummary();
        }

        function renderFileList() {
            if (!fileListEl) return;
            if (!filesBuffer.files.length) {
                fileListEl.textContent = 'Chưa chọn tệp tải lên';
                return;
            }
            fileListEl.innerHTML = Array.from(filesBuffer.files).map(file => {
                const sizeKb = Math.max(1, Math.round(file.size / 1024));
                return `<span class="badge bg-secondary me-2 mb-2">${file.name} (${sizeKb} KB)</span>`;
            }).join('');
        }

        function updateSummary() {
            if (!summaryEl) return;
            const urlCount = urlValues.length;
            const fileCount = filesBuffer.files.length;
            if (!urlCount && !fileCount) {
                summaryEl.textContent = 'Chưa chọn ảnh nào';
                return;
            }
            summaryEl.textContent = `Đã thêm ${urlCount} URL và ${fileCount} tệp tải lên`;
        }

        function updatePrimaryImage() {
            if (!primaryInput) return;
            primaryInput.value = urlValues.length ? urlValues[0] : defaultPrimary;
        }

        if (addUrlBtn && urlInput) {
            addUrlBtn.addEventListener('click', handleAddUrl);
            urlInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleAddUrl();
                }
            });
        }

        if (container && urlListEl) {
            container.addEventListener('click', function(event) {
                const btn = event.target.closest('[data-remove-url]');
                if (!btn) return;
                const row = btn.closest('[data-url-entry]');
                const url = row ? row.dataset.urlEntry : btn.getAttribute('data-remove-url');
                removeUrl(url, row);
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', function(event) {
                addFiles(event.target.files);
                fileInput.value = '';
            });
        }

        if (dropzone) {
            const baseBorder = dropzone.style.borderColor;
            dropzone.addEventListener('click', () => fileInput && fileInput.click());
            dropzone.addEventListener('dragover', function(event) {
                event.preventDefault();
                dropzone.style.borderColor = '#0d6efd';
                dropzone.style.backgroundColor = 'rgba(13,110,253,0.05)';
            });
            ['dragleave', 'dragend'].forEach(evt => {
                dropzone.addEventListener(evt, function() {
                    dropzone.style.borderColor = baseBorder;
                    dropzone.style.backgroundColor = '';
                });
            });
            dropzone.addEventListener('drop', function(event) {
                event.preventDefault();
                dropzone.style.borderColor = baseBorder;
                dropzone.style.backgroundColor = '';
                if (event.dataTransfer && event.dataTransfer.files) {
                    addFiles(event.dataTransfer.files);
                }
            });
        }

        parseInitialUrls();
        renderFileList();
        updateSummary();
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-image-picker]').forEach(initImagePicker);
    });
})();
</script>
